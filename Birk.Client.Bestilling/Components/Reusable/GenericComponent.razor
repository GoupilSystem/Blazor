@inherits BaseComponent;

@DynamicFragment

@code {
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }

    [Parameter]
    public string Placeholder { get; set; }

    private RenderFragment DynamicFragment;

    public string _bindValue;

    private RenderFragment CreateComponent() => builder =>
    {
        if (GuiType == Enums.GuiType.Title || GuiType == Enums.GuiType.Label)
        {
            builder.OpenElement(1, "div");
            builder.AddAttribute(2, "class", CssClass);
            builder.AddContent(3, (MarkupString)Items[0]);
        }
        else if (GuiType == Enums.GuiType.Input)
        {
            builder.OpenElement(1, "input");
            builder.AddMultipleAttributes(2, 
                new Dictionary<string, object>
                {
                    { "class", CssClass },
                    { "placeholder", Placeholder },
                    // Event triggered on content of input being changed
                    { "bind-value", _bindValue },
                    { "oninput", EventCallback.Factory.Create(this, OnInputValueChanged) },
                    // Event triggered on quit input (ex. copy/paste fnr value and click directly on Søk button)
                    // Ref: https://stackoverflow.com/questions/65803149/blazor-onchange-event
                    { "bind-value:event", "onchange" },
                    { "onchange", EventCallback.Factory.Create(this, OnBlurValueChanged) },
                    
                });
        }
        else if (GuiType == Enums.GuiType.Dropdown)
        {
            builder.OpenElement(1, "MudAutocomplete");
            builder.AddMultipleAttributes(2, 
                new Dictionary<string, object>
                {
                    { "class", CssClass },
                    { "placeholder", Placeholder }
                });
        }
        else if (GuiType == Enums.GuiType.Button)
        {
            builder.OpenElement(1, "button");
            builder.AddMultipleAttributes(2,
                new Dictionary<string, object>
                {
                    { "class", CssClass },
                    { "onclick", EventCallback.Factory.Create(this, OnClick) }
                });
            builder.AddContent(3, (MarkupString)Items[0]);
        }

        builder.CloseElement();
    };

    protected override void OnInitialized()
    {
        DynamicFragment = CreateComponent();
    }

    private void OnBlurValueChanged(ChangeEventArgs args)
    {
        _bindValue = args.Value?.ToString();
        ValueChanged.InvokeAsync(_bindValue);
    }

    private void OnInputValueChanged(ChangeEventArgs args)
    {
        _bindValue = args.Value?.ToString();
        ValueChanged.InvokeAsync(_bindValue);
    }

    private async Task HandleClick(MouseEventArgs e)
    {
        await OnClick.InvokeAsync(e);
    }
}